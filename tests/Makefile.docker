# Docker-based Test Suite Makefile
# This Makefile runs tests in Docker containers
# No need to install PostgreSQL, Redis and other services on local machine

.PHONY: help docker-test-setup docker-test-start docker-test-stop docker-test-clean docker-test-unit docker-test-integration docker-test-e2e docker-test-all docker-test-watch docker-test-logs

# Default target
help:
	@echo "Docker Test Suite Commands:"
	@echo "  docker-test-setup      - Setup Docker test environment for first time"
	@echo "  docker-test-start      - Start test containers"
	@echo "  docker-test-stop       - Stop test containers"
	@echo "  docker-test-clean      - Clean test containers and volumes"
	@echo "  docker-test-unit       - Run unit tests in Docker"
	@echo "  docker-test-integration - Run integration tests in Docker"
	@echo "  docker-test-e2e        - Run E2E tests in Docker"
	@echo "  docker-test-all        - Run all tests in Docker"
	@echo "  docker-test-watch      - Run tests in watch mode"
	@echo "  docker-test-logs       - View test container logs"

# Docker Compose file path
DOCKER_COMPOSE_FILE = ../deployments/test/docker-compose-test.yml
DOCKER_COMPOSE_CMD = docker-compose -f $(DOCKER_COMPOSE_FILE)

# Setup test environment (first time)
docker-test-setup:
	@echo "ğŸ³ Setting up Docker test environment..."
	@echo "ğŸ“‹ This command will set up:"
	@echo "   - Test PostgreSQL container (port 5434)"
	@echo "   - Test Redis container (port 6381)"
	@echo "   - Test API container (port 8082)"
	@echo "   - Jaeger tracing container (port 16688)"
	@echo ""
	@read -p "Do you want to continue? [y/N] " confirm && [ "$$confirm" = "y" ]
	$(DOCKER_COMPOSE_CMD) build --no-cache
	$(DOCKER_COMPOSE_CMD) pull
	@echo "âœ… Docker test environment ready!"

# Start test containers
docker-test-start:
	@echo "ğŸš€ Starting test containers..."
	$(DOCKER_COMPOSE_CMD) up -d
	@echo "â³ Waiting for containers to be ready..."
	@sleep 10
	@echo "ğŸ” Checking container status..."
	$(DOCKER_COMPOSE_CMD) ps
	@echo "âœ… Test environment ready!"
	@echo "ğŸ“ Access points:"
	@echo "   - API: http://localhost:8082"
	@echo "   - PostgreSQL: localhost:5434 (testuser/testpass/newsapi_test)"
	@echo "   - Redis: localhost:6381"
	@echo "   - Jaeger: http://localhost:16688"

# Stop test containers
docker-test-stop:
	@echo "ğŸ›‘ Test container'larÄ± durduruluyor..."
	$(DOCKER_COMPOSE_CMD) down
	@echo "âœ… Container'lar durduruldu!"

# Clean test environment (remove containers and volumes)
docker-test-clean:
	@echo "ğŸ§¹ Test environment temizleniyor..."
	@echo "âš ï¸  Bu iÅŸlem tÃ¼m test verilerini silecek!"
	@read -p "Emin misiniz? [y/N] " confirm && [ "$$confirm" = "y" ]
	$(DOCKER_COMPOSE_CMD) down -v --remove-orphans
	docker volume prune -f
	@echo "âœ… Test environment temizlendi!"

# Run unit tests in Docker
docker-test-unit:
	@echo "ğŸ§ª Unit testler Docker'da Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
	@if ! $(DOCKER_COMPOSE_CMD) ps | grep -q "news_test_api.*Up"; then \
		echo "âŒ Test container'larÄ± Ã§alÄ±ÅŸmÄ±yor. Ã–nce 'make docker-test-start' Ã§alÄ±ÅŸtÄ±rÄ±n."; \
		exit 1; \
	fi
	$(DOCKER_COMPOSE_CMD) exec test_api go test -v ./tests/unit/...
	@echo "âœ… Unit testler tamamlandÄ±!"

# Run integration tests in Docker
docker-test-integration:
	@echo "ğŸ”— Integration testler Docker'da Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
	@if ! $(DOCKER_COMPOSE_CMD) ps | grep -q "news_test_api.*Up"; then \
		echo "âŒ Test container'larÄ± Ã§alÄ±ÅŸmÄ±yor. Ã–nce 'make docker-test-start' Ã§alÄ±ÅŸtÄ±rÄ±n."; \
		exit 1; \
	fi
	$(DOCKER_COMPOSE_CMD) exec test_api go test -v ./tests/integration/...
	@echo "âœ… Integration testler tamamlandÄ±!"

# Run E2E tests in Docker
docker-test-e2e:
	@echo "ğŸ¯ E2E testler Docker'da Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
	@if ! $(DOCKER_COMPOSE_CMD) ps | grep -q "news_test_api.*Up"; then \
		echo "âŒ Test container'larÄ± Ã§alÄ±ÅŸmÄ±yor. Ã–nce 'make docker-test-start' Ã§alÄ±ÅŸtÄ±rÄ±n."; \
		exit 1; \
	fi
	$(DOCKER_COMPOSE_CMD) exec test_api go test -v ./tests/e2e/...
	@echo "âœ… E2E testler tamamlandÄ±!"

# Run all tests in Docker
docker-test-all:
	@echo "ğŸš€ TÃ¼m testler Docker'da Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
	@if ! $(DOCKER_COMPOSE_CMD) ps | grep -q "news_test_api.*Up"; then \
		echo "âŒ Test container'larÄ± Ã§alÄ±ÅŸmÄ±yor. Ã–nce 'make docker-test-start' Ã§alÄ±ÅŸtÄ±rÄ±n."; \
		exit 1; \
	fi
	@echo "1/3 ğŸ§ª Unit testler..."
	$(DOCKER_COMPOSE_CMD) exec test_api go test -v ./tests/unit/...
	@echo "2/3 ğŸ”— Integration testler..."
	$(DOCKER_COMPOSE_CMD) exec test_api go test -v ./tests/integration/...
	@echo "3/3 ğŸ¯ E2E testler..."
	$(DOCKER_COMPOSE_CMD) exec test_api go test -v ./tests/e2e/...
	@echo "âœ… TÃ¼m testler tamamlandÄ±!"

# Run tests with coverage in Docker
docker-test-coverage:
	@echo "ğŸ“Š Test coverage raporu Docker'da oluÅŸturuluyor..."
	@if ! $(DOCKER_COMPOSE_CMD) ps | grep -q "news_test_api.*Up"; then \
		echo "âŒ Test container'larÄ± Ã§alÄ±ÅŸmÄ±yor. Ã–nce 'make docker-test-start' Ã§alÄ±ÅŸtÄ±rÄ±n."; \
		exit 1; \
	fi
	$(DOCKER_COMPOSE_CMD) exec test_api go test -coverprofile=coverage.out ./tests/...
	$(DOCKER_COMPOSE_CMD) exec test_api go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage raporu oluÅŸturuldu: coverage.html"

# Watch mode for tests (requires entr or similar tool in container)
docker-test-watch:
	@echo "ğŸ‘ï¸  Watch mode'da testler Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
	@echo "ğŸ’¡ Dosya deÄŸiÅŸikliklerinde testler otomatik Ã§alÄ±ÅŸacak"
	@echo "ğŸ›‘ Durdurmak iÃ§in Ctrl+C"
	@if ! $(DOCKER_COMPOSE_CMD) ps | grep -q "news_test_api.*Up"; then \
		echo "âŒ Test container'larÄ± Ã§alÄ±ÅŸmÄ±yor. Ã–nce 'make docker-test-start' Ã§alÄ±ÅŸtÄ±rÄ±n."; \
		exit 1; \
	fi
	$(DOCKER_COMPOSE_CMD) exec test_api sh -c 'while true; do go test ./tests/unit/...; sleep 5; done'

# View logs from test containers
docker-test-logs:
	@echo "ğŸ“‹ Test container loglarÄ±:"
	$(DOCKER_COMPOSE_CMD) logs -f

# View specific service logs
docker-test-logs-api:
	$(DOCKER_COMPOSE_CMD) logs -f test_api

docker-test-logs-db:
	$(DOCKER_COMPOSE_CMD) logs -f test_db

docker-test-logs-redis:
	$(DOCKER_COMPOSE_CMD) logs -f test_redis

# Get shell access to test container
docker-test-shell:
	@echo "ğŸš Test container'a shell eriÅŸimi..."
	$(DOCKER_COMPOSE_CMD) exec test_api sh

# Quick test run (start containers, run tests, stop containers)
docker-test-quick:
	@echo "âš¡ HÄ±zlÄ± test Ã§alÄ±ÅŸtÄ±rmasÄ± (container'larÄ± baÅŸlat -> test -> durdur)"
	$(MAKE) docker-test-start
	sleep 15
	$(MAKE) docker-test-all || true
	$(MAKE) docker-test-stop

# Health check for test environment
docker-test-health:
	@echo "ğŸ¥ Test environment saÄŸlÄ±k kontrolÃ¼..."
	@echo "API Health Check:"
	@curl -f http://localhost:8082/health || echo "âŒ API eriÅŸilemez"
	@echo ""
	@echo "Database Connection:"
	@docker exec news_test_db pg_isready -U testuser -d newsapi_test || echo "âŒ Database eriÅŸilemez"
	@echo ""
	@echo "Redis Connection:"
	@docker exec news_test_redis redis-cli ping || echo "âŒ Redis eriÅŸilemez"
